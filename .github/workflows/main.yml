import os
import time
import hmac
import hashlib
import base64
import urllib.parse
import requests
import google.generativeai as genai

# --- 1. 自动对接 GitHub 保险箱 (Secrets) ---
GEMINI_KEY = os.getenv('GEMINI_API_KEY')
WEBHOOK_URL = os.getenv('WEBHOOK_URL')     # 对应 main.yml 里的 WEBHOOK_URL
DING_SECRET = os.getenv('DING_SECRET')     # 对应 main.yml 里的 DING_SECRET
IMGBB_KEY = os.getenv('IMGBB_KEY')
PROXY_URL = os.getenv('PROXY_URL')

# --- 2. 钉钉安全验证逻辑 (必须有，否则发不出) ---
def get_signed_url():
    timestamp = str(round(time.time() * 1000))
    secret_enc = DING_SECRET.encode('utf-8')
    string_to_sign = '{}\n{}'.format(timestamp, DING_SECRET)
    string_to_sign_enc = string_to_sign.encode('utf-8')
    hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest()
    sign = urllib.parse.quote(base64.b64encode(hmac_code))
    return f"{WEBHOOK_URL}&timestamp={timestamp}&sign={sign}"

# --- 3. 配置 Gemini AI ---
genai.configure(api_key=GEMINI_KEY)
model = genai.GenerativeModel('gemini-pro')

def main():
    try:
        # 这里放你原本抓取新闻的逻辑，下面是模拟一个总结
        news_content = "这里是你抓取到的原始新闻内容..." 
        
        # 调用 AI 总结
        response = model.generate_content(f"请简要总结以下新闻：{news_content}")
        summary = response.text
        
        # 发送到钉钉
        payload = {
            "msgtype": "markdown",
            "markdown": {
                "title": "AI 每日新闻总结",
                "text": f"### 每日 AI 新闻总结 \n\n {summary}"
            }
        }
        res = requests.post(get_signed_url(), json=payload)
        print(f"发送状态: {res.text}")
        
    except Exception as e:
        print(f"运行出错: {e}")

if __name__ == "__main__":
    main()
